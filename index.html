<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMS 시설물 관리시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-6xl mx-auto p-6">
        <!-- 헤더 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">🔗 FMS 시설물 관리시스템</h1>
            <p class="text-gray-600">순수 JavaScript로 구현된 확실한 CSV 검색 시스템</p>
            
            <!-- 상태 표시 -->
            <div id="status" class="mt-4 p-3 rounded-lg">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full animate-spin"></div>
                    <span class="text-yellow-700 font-medium">CSV 데이터 로딩 중...</span>
                </div>
            </div>
        </div>

        <!-- 검색 섹션 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">🔍 설비 검색</h2>
            <div class="flex gap-3 mb-4">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="검색어를 입력하세요..."
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    disabled
                >
                <button 
                    id="searchBtn" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    검색
                </button>
            </div>
            
            <!-- 빠른 검색 버튼 -->
            <div class="flex gap-2 flex-wrap">
                <button class="quick-search px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-term="SC01">SC01</button>
                <button class="quick-search px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-term="보일러">보일러</button>
                <button class="quick-search px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-term="전기">전기</button>
                <button class="quick-search px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-term="지하">지하</button>
                <button class="quick-search px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-term="2021">2021</button>
            </div>

            <!-- 데이터 정보 -->
            <div id="dataInfo" class="mt-4 text-sm text-gray-600"></div>
        </div>

        <!-- 검색 결과 -->
        <div id="results" class="space-y-4"></div>
    </div>

    <script>
        // 전역 변수
        let csvData = [];
        let isLoading = false;

        // DOM 요소
        const statusEl = document.getElementById('status');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsEl = document.getElementById('results');
        const dataInfoEl = document.getElementById('dataInfo');
        const quickSearchBtns = document.querySelectorAll('.quick-search');

        // 상태 업데이트
        function updateStatus(type, message, details = '') {
            const colors = {
                loading: 'bg-yellow-50 border-yellow-200 text-yellow-700',
                success: 'bg-green-50 border-green-200 text-green-700',
                error: 'bg-red-50 border-red-200 text-red-700'
            };
            
            const icons = {
                loading: '<div class="w-3 h-3 bg-yellow-500 rounded-full animate-spin"></div>',
                success: '<div class="w-3 h-3 bg-green-500 rounded-full"></div>',
                error: '<div class="w-3 h-3 bg-red-500 rounded-full"></div>'
            };

            statusEl.className = `mt-4 p-3 rounded-lg border ${colors[type]}`;
            statusEl.innerHTML = `
                <div class="flex items-center gap-2">
                    ${icons[type]}
                    <span class="font-medium">${message}</span>
                </div>
                ${details ? `<div class="mt-2 text-sm">${details}</div>` : ''}
            `;
        }

        // CSV 로드 및 파싱
        async function loadCSVData() {
            try {
                console.log('🚀 CSV 로딩 시작...');
                updateStatus('loading', 'CSV 파일을 불러오는 중...');
                
                const response = await fetch('./data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('📄 CSV 크기:', csvText.length, '바이트');
                
                // 다양한 구분자로 파싱 시도
                const separators = [',', ';', '\t', '|'];
                let bestResult = { data: [], separator: '', count: 0 };
                
                for (const sep of separators) {
                    try {
                        const result = parseCSV(csvText, sep);
                        console.log(`📊 ${sep === ',' ? '콤마' : sep === ';' ? '세미콜론' : sep === '\t' ? '탭' : '파이프'} 구분자: ${result.length}개`);
                        
                        if (result.length > bestResult.count) {
                            bestResult = { data: result, separator: sep, count: result.length };
                        }
                    } catch (e) {
                        console.log(`❌ ${sep} 구분자 실패:`, e.message);
                    }
                }
                
                if (bestResult.count === 0) {
                    throw new Error('어떤 구분자로도 데이터를 파싱할 수 없습니다');
                }
                
                csvData = bestResult.data;
                console.log('✅ 최종 데이터:', csvData.length, '개');
                console.log('🔍 첫 번째 데이터:', csvData[0]);
                
                updateStatus('success', `✅ CSV 데이터 로드 성공!`, 
                    `총 ${csvData.length}개 데이터 • 구분자: ${bestResult.separator === ',' ? '콤마(,)' : bestResult.separator === ';' ? '세미콜론(;)' : bestResult.separator === '\t' ? '탭' : '파이프(|)'}`
                );
                
                // 검색 활성화
                searchInput.disabled = false;
                searchBtn.disabled = false;
                quickSearchBtns.forEach(btn => btn.disabled = false);
                
                // 데이터 정보 표시
                if (csvData.length > 0) {
                    const headers = Object.keys(csvData[0]);
                    dataInfoEl.innerHTML = `
                        <div><strong>컬럼:</strong> ${headers.slice(0, 5).join(', ')}${headers.length > 5 ? ` 외 ${headers.length - 5}개` : ''}</div>
                        <div><strong>검색 가능:</strong> 모든 필드에서 통합 검색</div>
                    `;
                }
                
            } catch (error) {
                console.error('❌ CSV 로드 오류:', error);
                updateStatus('error', '❌ 데이터 로드 실패', error.message);
            }
        }

        // CSV 파싱 함수
        function parseCSV(csvText, separator) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            if (lines.length < 2) {
                throw new Error('데이터가 부족합니다');
            }
            
            // 헤더 파싱
            const headers = lines[0].split(separator).map(h => h.replace(/^"|"$/g, '').trim());
            
            if (headers.length < 2) {
                throw new Error('충분한 컬럼이 없습니다');
            }
            
            // 데이터 파싱
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.replace(/^"|"$/g, '').trim());
                
                if (values.length >= Math.max(2, headers.length - 3)) { // 관대한 검증
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    
                    // 유효한 데이터인지 확인
                    if (Object.values(row).some(v => v && v.length > 0)) {
                        data.push(row);
                    }
                }
            }
            
            if (data.length === 0) {
                throw new Error('유효한 데이터가 없습니다');
            }
            
            return data;
        }

        // 검색 함수
        function performSearch(term) {
            if (!term || !term.trim()) {
                resultsEl.innerHTML = '';
                return;
            }
            
            console.log('🔍 검색 시작:', term);
            const searchTerm = term.toLowerCase();
            
            // 검색 실행
            const results = csvData.filter(row => {
                return Object.values(row).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                );
            });
            
            console.log('📋 검색 결과:', results.length, '개');
            
            // 결과 표시
            displayResults(results, term);
        }

        // 결과 표시 함수
        function displayResults(results, searchTerm) {
            if (results.length === 0) {
                resultsEl.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                        <div class="text-4xl mb-4">🔍</div>
                        <h3 class="text-lg font-bold text-gray-600 mb-2">검색 결과가 없습니다</h3>
                        <p class="text-gray-500">"${searchTerm}"에 대한 결과를 찾을 수 없습니다</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                    <h3 class="text-lg font-bold text-blue-600">📋 검색 결과 (${results.length}건)</h3>
                    <p class="text-sm text-gray-600">"${searchTerm}" 검색 결과</p>
                </div>
                ${results.slice(0, 20).map((row, index) => {
                    const values = Object.values(row);
                    const keys = Object.keys(row);
                    
                    return `
                        <div class="bg-white rounded-lg shadow-sm p-5 border-l-4 border-blue-500">
                            <div class="flex items-start gap-4">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <span class="text-blue-600 font-bold">${index + 1}</span>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-lg text-gray-900 mb-2">${values[0] || `항목 ${index + 1}`}</h4>
                                    <div class="text-gray-700 mb-3">${values[1] || values[2] || '상세정보 없음'}</div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                                        ${values.slice(2, 6).filter(v => v).map(v => `<div>• ${v}</div>`).join('')}
                                    </div>
                                    <details class="text-xs">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-800 mb-2">전체 데이터 보기</summary>
                                        <div class="bg-gray-50 p-3 rounded text-xs font-mono overflow-x-auto">
                                            ${Object.entries(row).map(([k, v]) => `<div><strong>${k}:</strong> ${v}</div>`).join('')}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
            
            resultsEl.innerHTML = html;
        }

        // 이벤트 리스너
        searchBtn.addEventListener('click', () => {
            performSearch(searchInput.value);
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch(searchInput.value);
            }
        });

        quickSearchBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const term = btn.dataset.term;
                searchInput.value = term;
                performSearch(term);
            });
        });

        // 페이지 로드 시 CSV 데이터 로드
        window.addEventListener('load', loadCSVData);
    </script>
</body>
</html>
